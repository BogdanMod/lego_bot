(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[658],{6615:(e,t,r)=>{"use strict";r.d(t,{CabinetLayout:()=>h});var n=r(33931),s=r(16144),a=r(78407),o=r(51259),l=r(84483),i=r(86804),c=r(57023),d=r(65940);function u(e){let{bots:t,currentBotId:r}=e,s=(0,i.useRouter)(),a=(0,i.usePathname)(),[l,u]=(0,o.useState)(!1),[m,b]=(0,o.useState)(""),x=(0,o.useRef)(null),h=t.find(e=>e.botId===r),g=m?t.filter(e=>e.name.toLowerCase().includes(m.toLowerCase())):t;(0,o.useEffect)(()=>{let e=e=>{x.current&&!x.current.contains(e.target)&&(u(!1),b(""))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);let v=h?d.R.roles[h.role]||h.role:"";return(0,n.jsxs)("div",{className:"relative",ref:x,children:[(0,n.jsxs)("button",{onClick:()=>u(!l),className:"flex items-center gap-2 px-3 py-2 rounded-lg border border-border bg-card hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[(0,n.jsxs)("div",{className:"text-left",children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:(null==h?void 0:h.name)||d.R.bot.selectBot}),h&&(0,n.jsxs)("div",{className:"text-xs text-muted-foreground",children:[d.R.bot.context,": ",h.name]})]}),h&&v&&(0,n.jsx)(c.E,{variant:"owner"===h.role?"success":"default",children:v}),(0,n.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat(l?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),l&&(0,n.jsxs)("div",{className:"absolute top-full left-0 mt-1 w-64 bg-card border border-border rounded-lg shadow-lg z-50 max-h-96 overflow-hidden flex flex-col",children:[(0,n.jsx)("div",{className:"p-2 border-b border-border",children:(0,n.jsx)("input",{type:"text",placeholder:d.R.common.search,value:m,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 text-sm rounded border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary",autoFocus:!0})}),(0,n.jsx)("div",{className:"overflow-y-auto",children:0===g.length?(0,n.jsx)("div",{className:"p-4 text-sm text-muted-foreground text-center",children:d.R.bot.noBots}):g.map(e=>(0,n.jsx)("button",{onClick:()=>(e=>{u(!1),b("");let t=a.match(/\/cabinet\/[^/]+\/(.+)/),r=t?t[1]:"overview";s.push("/cabinet/".concat(e,"/").concat(r)),localStorage.setItem("owner_lastBotId",e)})(e.botId),className:"w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors ".concat(e.botId===r?"bg-primary/10":""),children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:e.name}),(0,n.jsxs)("div",{className:"text-xs text-muted-foreground",children:["ID: ",e.botId.slice(0,8),"..."]})]}),(0,n.jsx)(c.E,{variant:"owner"===e.role?"success":"default",children:d.R.roles[e.role]||e.role})]})},e.botId))})]})]})}function m(e){let{botId:t}=e,{isOpen:r,setIsOpen:s,search:a,setSearch:l,commands:c}=function(e){let t=(0,i.useRouter)();(0,i.usePathname)();let[r,n]=(0,o.useState)(!1),[s,a]=(0,o.useState)("");(0,o.useEffect)(()=>{let e=e=>{(e.metaKey||e.ctrlKey)&&"k"===e.key&&(e.preventDefault(),n(e=>!e)),"Escape"===e.key&&r&&(n(!1),a(""))};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[r]);let l=e?[{id:"inbox",label:d.R.nav.inbox,shortcut:"g i",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/inbox")),n(!1)}},{id:"calendar",label:d.R.nav.calendar,shortcut:"g k",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/calendar")),n(!1)}},{id:"orders",label:d.R.nav.orders,shortcut:"g o",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/orders")),n(!1)}},{id:"leads",label:d.R.nav.leads,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/leads")),n(!1)}},{id:"customers",label:d.R.nav.customers,shortcut:"g c",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/customers")),n(!1)}},{id:"overview",label:d.R.nav.overview,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/overview")),n(!1)}},{id:"team",label:d.R.nav.team,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/team")),n(!1)}},{id:"settings",label:d.R.nav.settings,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/settings")),n(!1)}}]:[],c=s?l.filter(e=>e.label.toLowerCase().includes(s.toLowerCase())):l;return{isOpen:r,setIsOpen:n,search:s,setSearch:a,commands:c}}(t),u=(0,o.useRef)(null);return((0,o.useEffect)(()=>{r&&u.current&&u.current.focus()},[r]),r)?(0,n.jsxs)("div",{className:"fixed inset-0 z-50 flex items-start justify-center pt-[20vh]",children:[(0,n.jsx)("div",{className:"fixed inset-0 bg-black/50",onClick:()=>s(!1)}),(0,n.jsxs)("div",{className:"relative w-full max-w-2xl bg-card border border-border rounded-lg shadow-xl",children:[(0,n.jsx)("div",{className:"p-4 border-b border-border",children:(0,n.jsx)("input",{ref:u,type:"text",placeholder:"Поиск команд...",value:a,onChange:e=>l(e.target.value),className:"w-full bg-transparent outline-none text-lg"})}),(0,n.jsx)("div",{className:"max-h-96 overflow-y-auto",children:0===c.length?(0,n.jsx)("div",{className:"p-4 text-sm text-muted-foreground text-center",children:"Нет результатов"}):c.map(e=>(0,n.jsxs)("button",{onClick:e.action,className:"w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-medium",children:e.label}),(0,n.jsx)("div",{className:"text-xs text-muted-foreground",children:e.category})]}),e.shortcut&&(0,n.jsx)("kbd",{className:"px-2 py-1 text-xs bg-slate-100 dark:bg-slate-800 rounded",children:e.shortcut})]},e.id))})]})]}):null}let b=[{key:"overview",label:d.R.nav.overview},{key:"inbox",label:d.R.nav.inbox},{key:"calendar",label:d.R.nav.calendar},{key:"orders",label:d.R.nav.orders},{key:"leads",label:d.R.nav.leads},{key:"customers",label:d.R.nav.customers},{key:"team",label:d.R.nav.team},{key:"settings",label:d.R.nav.settings},{key:"audit",label:d.R.nav.audit}],x={key:"bots",label:d.R.nav.bots,icon:"\uD83E\uDD16"};function h(e){var t,r;let{children:c}=e,h=(0,i.useRouter)(),g=(0,i.usePathname)(),v=(0,i.useParams)(),{data:f,isLoading:p,isError:y}=(0,a.n)(),w=null==v?void 0:v.botId;(null==f||null==(t=f.bots)?void 0:t.find(e=>e.botId===w))||null==f||null==(r=f.bots)||r[0];let k=(0,i.useRouter)();(0,o.useEffect)(()=>{let e=e=>{var t;if("/"===e.key&&(null==(t=e.target)?void 0:t.tagName)!=="INPUT"){e.preventDefault();let t=document.getElementById("global-search");null==t||t.focus()}if("g"===e.key.toLowerCase()&&w){let e=t=>{"i"===t.key.toLowerCase()&&k.push("/cabinet/".concat(w,"/inbox")),"c"===t.key.toLowerCase()&&k.push("/cabinet/".concat(w,"/calendar")),document.removeEventListener("keydown",e)};document.addEventListener("keydown",e)}};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[w,k]);let j=(0,l.jE)(),N=(0,o.useRef)(null);if((0,o.useEffect)(()=>{if(!w)return;let e=new EventSource("/api/core/owner/bots/".concat(w,"/stream"));return N.current=e,e.onopen=()=>{console.log("[SSE] Connected",{botId:w})},e.addEventListener("connected",e=>{console.log("[SSE] Connection confirmed",JSON.parse(e.data))}),e.addEventListener("event",e=>{console.log("[SSE] Event received",JSON.parse(e.data)),j.invalidateQueries({queryKey:["owner-section",w]}),j.invalidateQueries({queryKey:["owner-events",w]}),j.invalidateQueries({queryKey:["owner-customers",w]}),j.invalidateQueries({queryKey:["owner-orders",w]}),j.invalidateQueries({queryKey:["owner-leads",w]})}),e.addEventListener("ping",()=>{}),e.addEventListener("error",e=>{console.error("[SSE] Error",e)}),e.onerror=e=>{console.error("[SSE] Connection error",e)},()=>{e.close(),N.current=null}},[w,j]),(0,o.useEffect)(()=>{if(!p&&(y||!f)){if(y){let e=(null==f?void 0:f.error)||f;console.error("[OwnerAuth] Auth check failed:",{code:null==e?void 0:e.code,message:null==e?void 0:e.message,request_id:null==e?void 0:e.request_id})}h.replace("/login")}},[y,p,f,h]),p||!f){if(y&&!p){let e=(null==f?void 0:f.error)||f,t=(null==e?void 0:e.message)||"Ошибка авторизации";return(0,n.jsx)("div",{className:"min-h-screen p-8",children:(0,n.jsxs)("div",{className:"panel p-6 max-w-2xl mx-auto",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Ошибка авторизации"}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:t}),(null==e?void 0:e.code)==="misconfigured"||(null==e?void 0:e.code)==="proxy_misconfigured"?(0,n.jsxs)("div",{className:"mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800",children:[(0,n.jsx)("p",{className:"text-sm font-medium mb-2",children:"Проверьте настройки:"}),(0,n.jsxs)("ul",{className:"text-xs space-y-1 list-disc list-inside",children:[t.includes("CORE_API_ORIGIN")&&(0,n.jsxs)("li",{children:["В сервисе ",(0,n.jsx)("code",{className:"bg-slate-100 dark:bg-slate-800 px-1 rounded",children:"owner-web"})," должна быть переменная ",(0,n.jsx)("code",{className:"bg-slate-100 dark:bg-slate-800 px-1 rounded",children:"CORE_API_ORIGIN"})]}),t.includes("JWT_SECRET")&&(0,n.jsxs)("li",{children:["В сервисе ",(0,n.jsx)("code",{className:"bg-slate-100 dark:bg-slate-800 px-1 rounded",children:"core"})," должна быть переменная ",(0,n.jsx)("code",{className:"bg-slate-100 dark:bg-slate-800 px-1 rounded",children:"JWT_SECRET"})]}),t.includes("TELEGRAM_BOT_TOKEN")&&(0,n.jsxs)("li",{children:["В сервисе ",(0,n.jsx)("code",{className:"bg-slate-100 dark:bg-slate-800 px-1 rounded",children:"core"})," должна быть переменная ",(0,n.jsx)("code",{className:"bg-slate-100 dark:bg-slate-800 px-1 rounded",children:"TELEGRAM_BOT_TOKEN"})]})]}),(0,n.jsx)("p",{className:"text-xs mt-3 text-muted-foreground",children:(0,n.jsx)("a",{href:"/api/_debug/env",target:"_blank",className:"text-blue-500 hover:underline",children:"Проверить env переменные (dev only)"})})]}):null,(0,n.jsx)("button",{onClick:()=>h.push("/login"),className:"mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90",children:"Вернуться к входу"})]})})}return(0,n.jsx)("div",{className:"min-h-screen p-8",children:d.R.common.loading})}return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(m,{botId:w}),(0,n.jsxs)("div",{className:"min-h-screen grid grid-cols-[260px_1fr]",children:[(0,n.jsxs)("aside",{className:"border-r border-border bg-card p-5",children:[(0,n.jsx)("div",{className:"text-xl font-semibold",children:"Owner Cabinet"}),(0,n.jsx)("div",{className:"mt-1 text-sm text-muted-foreground",children:f.user.firstName||"Пользователь"}),(0,n.jsx)("div",{className:"mt-6 text-xs uppercase tracking-wide text-muted-foreground",children:"Разделы"}),(0,n.jsxs)("nav",{className:"mt-2 space-y-1",children:[(0,n.jsxs)("button",{onClick:()=>h.push("/cabinet/bots"),className:"w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ".concat(g.startsWith("/cabinet/bots")&&!g.match(/\/cabinet\/bots\/[^/]+\//)?"bg-primary text-white":"hover:bg-slate-100 dark:hover:bg-slate-800 text-foreground"),children:[x.icon," ",x.label]}),b.map(e=>{let t=w?"/cabinet/".concat(w,"/").concat(e.key):"/cabinet",r=g.startsWith(t);return(0,n.jsx)("button",{onClick:()=>h.push(t),className:"w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ".concat(r?"bg-primary text-white":"hover:bg-slate-100 dark:hover:bg-slate-800 text-foreground"),children:e.label},e.key)})]}),(0,n.jsx)("button",{className:"mt-8 w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",onClick:async()=>{await (0,s.SJ)(),h.replace("/login")},children:"Выйти"})]}),(0,n.jsxs)("div",{className:"p-6",children:[(0,n.jsxs)("header",{className:"panel px-4 py-3 flex items-center gap-3 justify-between mb-4",children:[(0,n.jsx)(u,{bots:f.bots||[],currentBotId:w}),(0,n.jsx)("input",{id:"global-search",placeholder:"".concat(d.R.common.search," (/)"),className:"w-[360px] rounded-lg border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-primary",onChange:async e=>{if(!w)return;let t=e.target.value.trim();t&&await (0,s.CK)("/api/owner/bots/".concat(w,"/events?q=").concat(encodeURIComponent(t),"&limit=20"))}})]}),(0,n.jsx)("div",{children:c})]})]})]})}},16144:(e,t,r)=>{"use strict";r.d(t,{CK:()=>x,D6:()=>v,FO:()=>c,HP:()=>p,JD:()=>f,Kj:()=>g,Lu:()=>d,SJ:()=>m,qf:()=>u,w1:()=>h});var n=r(13305);let s="/api/core",a=null,o=n.Ik({user:n.Ik({telegramUserId:n.ai(),username:n.Yj().nullable().optional(),firstName:n.Yj().nullable().optional(),lastName:n.Yj().nullable().optional(),photoUrl:n.Yj().nullable().optional()}),bots:n.YO(n.Ik({botId:n.Yj(),name:n.Yj(),role:n.Yj()})),csrfToken:n.Yj()});async function l(e,t){let r="undefined"!=typeof AbortController?new AbortController:null,n=r?setTimeout(()=>r.abort(),3e3):null;try{let s=await fetch(e,{...t,signal:null==r?void 0:r.signal,credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},cache:"no-store"});n&&clearTimeout(n);let o=await s.json().catch(()=>({}));if(!s.ok){let e=(null==o?void 0:o.message)||"Ошибка запроса",t=(null==o?void 0:o.code)||"request_failed";if("proxy_misconfigured"===t||e.includes("CORE_API_ORIGIN"))e="CORE_API_ORIGIN не настроен. Проверьте переменные окружения в Railway.";else if("misconfigured"===t&&e.includes("Owner auth is not configured")){let t=e.match(/missing ([^,]+(?:, [^,]+)*)/);e=t?"Owner auth не настроен: отсутствуют ".concat(t[1],". Проверьте переменные окружения в сервисе core."):"Owner auth не настроен. Проверьте JWT_SECRET и TELEGRAM_BOT_TOKEN в сервисе core."}if("csrf_failed"===t||"csrf_token_mismatch"===t){a=null;try{a=(await u()).csrfToken||null,e="CSRF токен обновлен. Попробуйте еще раз."}catch(t){e="Ошибка CSRF токена. Обновите страницу."}}else(401===s.status||403===s.status)&&("unauthorized"===t||"invalid_telegram_auth"===t)&&(e=e||"Требуется авторизация. Войдите через Telegram.");throw{code:t,message:e,request_id:null==o?void 0:o.request_id,details:null==o?void 0:o.details}}return o}catch(e){if(n&&clearTimeout(n),(null==e?void 0:e.name)==="AbortError")throw{code:"timeout",message:"Request timeout (3000ms)"};throw e}}function i(e){return e.startsWith("/api/core/")?e:e.startsWith("/api/")?e.replace(/^\/api\//,"/api/core/"):e.startsWith("/")?"".concat(s).concat(e):"".concat(s,"/").concat(e)}function c(e){return l(i("/api/owner/auth/telegram"),{method:"POST",body:JSON.stringify(e)})}function d(e,t){return l(i("/api/owner/auth/botlink"),{method:"POST",body:JSON.stringify({token:e,...t?{next:t}:{}})})}async function u(){let e=await l(i("/api/owner/auth/me")),t=o.parse(e);return a=t.csrfToken,t}function m(){return l(i("/api/owner/auth/logout"),{method:"POST"})}async function b(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(a&&!e)return a;try{return a=(await u()).csrfToken||null}catch(e){return a=null,null}}async function x(e,t){let r=(null==t?void 0:t.method)||"GET",n={};if("GET"!==r){let e=(null==t?void 0:t.csrfToken)||await b();e&&(n["x-csrf-token"]=e)}return l(i(e),{method:r,headers:n,body:(null==t?void 0:t.body)!==void 0?JSON.stringify(t.body):void 0})}async function h(){return l(i("/api/owner/summary"))}async function g(){return l(i("/api/owner/bots"))}async function v(e){return console.log(JSON.stringify({action:"owner_deactivate_bot",botId:e,timestamp:new Date().toISOString()})),await b(),x("/api/owner/bots/".concat(e),{method:"DELETE"})}async function f(){return x("/api/owner/templates")}async function p(e){return x("/api/owner/bots",{method:"POST",body:e})}},25632:(e,t,r)=>{Promise.resolve().then(r.bind(r,6615))},36669:(e,t,r)=>{"use strict";r.d(t,{cn:()=>a});var n=r(73682),s=r(72454);function a(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,s.QP)((0,n.$)(t))}},57023:(e,t,r)=>{"use strict";r.d(t,{E:()=>a});var n=r(33931),s=r(36669);function a(e){let{variant:t="default",children:r,className:a}=e;return(0,n.jsx)("span",{className:(0,s.cn)("inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium",{"bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-200":"default"===t,"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":"success"===t,"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"warning"===t,"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200":"danger"===t,"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200":"info"===t},a),children:r})}},65940:(e,t,r)=>{"use strict";r.d(t,{R:()=>n});let n={common:{loading:"Загрузка...",error:"Ошибка",save:"Сохранить",cancel:"Отмена",delete:"Удалить",edit:"Редактировать",create:"Создать",search:"Поиск",filter:"Фильтр",clear:"Очистить",apply:"Применить",close:"Закрыть",back:"Назад",next:"Далее",previous:"Назад",refresh:"Обновить",export:"Экспорт",import:"Импорт"},nav:{bots:"Мои боты",overview:"Обзор",inbox:"Входящие",calendar:"Календарь",orders:"Заказы",leads:"Лиды",customers:"Клиенты",team:"Команда",settings:"Настройки",audit:"Аудит"},roles:{owner:"Владелец",admin:"Администратор",staff:"Сотрудник",viewer:"Наблюдатель"},bot:{selectBot:"Выберите бота",switchBot:"Переключить бота",noBots:"Нет доступных ботов",context:"Контекст",role:"Роль"},inbox:{title:"Входящие",new:"Новые",inProgress:"В работе",done:"Выполнено",cancelled:"Отменено",unassigned:"Не назначено",assignToMe:"Назначить мне",markAsDone:"Отметить выполненным",createOrder:"Создать заказ",createLead:"Создать лид",createAppointment:"Создать запись",empty:"Нет событий",emptyDesc:"Все события будут отображаться здесь"},orders:{title:"Заказы",new:"Новые",processing:"В обработке",completed:"Завершено",cancelled:"Отменено",empty:"Нет заказов",emptyDesc:"Заказы будут отображаться здесь"},leads:{title:"Лиды",new:"Новые",contacted:"Связались",qualified:"Квалифицированы",converted:"Конвертированы",lost:"Потеряны",empty:"Нет лидов",emptyDesc:"Лиды будут отображаться здесь"},customers:{title:"Клиенты",empty:"Нет клиентов",emptyDesc:"Клиенты будут отображаться здесь"},calendar:{title:"Календарь",empty:"Нет записей",emptyDesc:"Записи будут отображаться здесь"},team:{title:"Команда",addMember:"Добавить участника",empty:"Нет участников",emptyDesc:"Добавьте участников команды"},settings:{title:"Настройки",general:"Общие",notifications:"Уведомления",integrations:"Интеграции"},audit:{title:"Аудит",empty:"Нет записей",emptyDesc:"История изменений будет отображаться здесь"},errors:{notFound:"Не найдено",unauthorized:"Требуется авторизация",forbidden:"Доступ запрещен",serverError:"Ошибка сервера",networkError:"Ошибка сети",unknown:"Неизвестная ошибка",requestId:"ID запроса",details:"Подробнее"},dashboard:{title:"Обзор",kpi:{newLeads:"Новые лиды",orders:"Заказы",revenue:"Выручка",conversion:"Конверсия"},trends:"Тренды",recent:"Недавние"}}},78407:(e,t,r)=>{"use strict";r.d(t,{n:()=>a});var n=r(30883),s=r(16144);function a(){return(0,n.I)({queryKey:["owner-me"],queryFn:s.qf,retry:!1})}}},e=>{e.O(0,[305,163,883,844,765,337,358],()=>e(e.s=25632)),_N_E=e.O()}]);