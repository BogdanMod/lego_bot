(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[553],{16144:(e,t,s)=>{"use strict";s.d(t,{CK:()=>b,D6:()=>v,FO:()=>u,HP:()=>x,JD:()=>y,Kj:()=>f,Lu:()=>c,SJ:()=>h,qf:()=>d,w1:()=>p});var r=s(13305);let i="/api/core",n=null,a=r.Ik({user:r.Ik({telegramUserId:r.ai(),username:r.Yj().nullable().optional(),firstName:r.Yj().nullable().optional(),lastName:r.Yj().nullable().optional(),photoUrl:r.Yj().nullable().optional()}),bots:r.YO(r.Ik({botId:r.Yj(),name:r.Yj(),role:r.Yj()})),csrfToken:r.Yj()});async function o(e,t){let s="undefined"!=typeof AbortController?new AbortController:null,r=s?setTimeout(()=>s.abort(),3e3):null;try{let i=await fetch(e,{...t,signal:null==s?void 0:s.signal,credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},cache:"no-store"});r&&clearTimeout(r);let a=await i.json().catch(()=>({}));if(!i.ok){let e=(null==a?void 0:a.message)||"Ошибка запроса",t=(null==a?void 0:a.code)||"request_failed";if("proxy_misconfigured"===t||e.includes("CORE_API_ORIGIN"))e="CORE_API_ORIGIN не настроен. Проверьте переменные окружения в Railway.";else if("misconfigured"===t&&e.includes("Owner auth is not configured")){let t=e.match(/missing ([^,]+(?:, [^,]+)*)/);e=t?"Owner auth не настроен: отсутствуют ".concat(t[1],". Проверьте переменные окружения в сервисе core."):"Owner auth не настроен. Проверьте JWT_SECRET и TELEGRAM_BOT_TOKEN в сервисе core."}if("csrf_failed"===t||"csrf_token_mismatch"===t){n=null;try{n=(await d()).csrfToken||null,e="CSRF токен обновлен. Попробуйте еще раз."}catch(t){e="Ошибка CSRF токена. Обновите страницу."}}else(401===i.status||403===i.status)&&("unauthorized"===t||"invalid_telegram_auth"===t)&&(e=e||"Требуется авторизация. Войдите через Telegram.");throw{code:t,message:e,request_id:null==a?void 0:a.request_id,details:null==a?void 0:a.details}}return a}catch(e){if(r&&clearTimeout(r),(null==e?void 0:e.name)==="AbortError")throw{code:"timeout",message:"Request timeout (3000ms)"};throw e}}function l(e){return e.startsWith("/api/core/")?e:e.startsWith("/api/")?e.replace(/^\/api\//,"/api/core/"):e.startsWith("/")?"".concat(i).concat(e):"".concat(i,"/").concat(e)}function u(e){return o(l("/api/owner/auth/telegram"),{method:"POST",body:JSON.stringify(e)})}function c(e,t){return o(l("/api/owner/auth/botlink"),{method:"POST",body:JSON.stringify({token:e,...t?{next:t}:{}})})}async function d(){let e=await o(l("/api/owner/auth/me")),t=a.parse(e);return n=t.csrfToken,t}function h(){return o(l("/api/owner/auth/logout"),{method:"POST"})}async function m(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(n&&!e)return n;try{return n=(await d()).csrfToken||null}catch(e){return n=null,null}}async function b(e,t){let s=(null==t?void 0:t.method)||"GET",r={};if("GET"!==s){let e=(null==t?void 0:t.csrfToken)||await m();e&&(r["x-csrf-token"]=e)}return o(l(e),{method:s,headers:r,body:(null==t?void 0:t.body)!==void 0?JSON.stringify(t.body):void 0})}async function p(){return o(l("/api/owner/summary"))}async function f(){return o(l("/api/owner/bots"))}async function v(e){return console.log(JSON.stringify({action:"owner_deactivate_bot",botId:e,timestamp:new Date().toISOString()})),await m(),b("/api/owner/bots/".concat(e),{method:"DELETE"})}async function y(){return b("/api/owner/templates")}async function x(e){return b("/api/owner/bots",{method:"POST",body:e})}},37935:(e,t,s)=>{"use strict";s.d(t,{n:()=>c});var r=s(51259),i=s(14860),n=s(28913),a=s(97194),o=s(92784),l=class extends a.Q{#e;#t=void 0;#s;#r;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#i()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,o.f8)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#s,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,o.EN)(t.mutationKey)!==(0,o.EN)(this.options.mutationKey)?this.reset():this.#s?.state.status==="pending"&&this.#s.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#s?.removeObserver(this)}onMutationUpdate(e){this.#i(),this.#n(e)}getCurrentResult(){return this.#t}reset(){this.#s?.removeObserver(this),this.#s=void 0,this.#i(),this.#n()}mutate(e,t){return this.#r=t,this.#s?.removeObserver(this),this.#s=this.#e.getMutationCache().build(this.#e,this.options),this.#s.addObserver(this),this.#s.execute(e)}#i(){let e=this.#s?.state??(0,i.$)();this.#t={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#n(e){n.jG.batch(()=>{if(this.#r&&this.hasListeners()){let t=this.#t.variables,s=this.#t.context,r={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};if(e?.type==="success"){try{this.#r.onSuccess?.(e.data,t,s,r)}catch(e){Promise.reject(e)}try{this.#r.onSettled?.(e.data,null,t,s,r)}catch(e){Promise.reject(e)}}else if(e?.type==="error"){try{this.#r.onError?.(e.error,t,s,r)}catch(e){Promise.reject(e)}try{this.#r.onSettled?.(void 0,e.error,t,s,r)}catch(e){Promise.reject(e)}}}this.listeners.forEach(e=>{e(this.#t)})})}},u=s(84483);function c(e,t){let s=(0,u.jE)(t),[i]=r.useState(()=>new l(s,e));r.useEffect(()=>{i.setOptions(e)},[i,e]);let a=r.useSyncExternalStore(r.useCallback(e=>i.subscribe(n.jG.batchCalls(e)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),c=r.useCallback((e,t)=>{i.mutate(e,t).catch(o.lQ)},[i]);if(a.error&&(0,o.GU)(i.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}},44556:(e,t,s)=>{Promise.resolve().then(s.bind(s,50384))},50384:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var r=s(33931),i=s(78407),n=s(86804),a=s(51259),o=s(84483),l=s(30883),u=s(37935),c=s(43826),d=s(16144);function h(){var e,t,s;let h=(0,n.useRouter)(),m=(0,o.jE)(),{data:b}=(0,i.n)(),[p,f]=(0,a.useState)(!1),[v,y]=(0,a.useState)(null),[x,g]=(0,a.useState)(!1),{data:w,isLoading:j}=(0,l.I)({queryKey:["owner-summary"],queryFn:d.w1,enabled:!!b}),{data:N,isLoading:O}=(0,l.I)({queryKey:["owner-bots"],queryFn:d.Kj,enabled:!!b}),R=(0,u.n)({mutationFn:d.D6,onSuccess:()=>{m.invalidateQueries({queryKey:["owner-bots"]}),m.invalidateQueries({queryKey:["owner-summary"]}),m.invalidateQueries({queryKey:["owner-me"]}),c.oR.success("Бот успешно деактивирован")},onError:e=>{c.oR.error((null==e?void 0:e.message)||"Ошибка при деактивации бота")}});(0,a.useEffect)(()=>{let e;if((null==b?void 0:b.bots)&&0!==b.bots.length){{let e=new URLSearchParams(window.location.search).get("openBot");if(e&&b.bots.some(t=>t.botId===e)){let t=new URL(window.location.href);t.searchParams.delete("openBot"),window.history.replaceState({},"",t.toString()),h.replace("/cabinet/".concat(e,"/overview"));return}}{let e=new URLSearchParams(window.location.search).get("redirect");if(e&&e.startsWith("/cabinet/")){let t=new URL(window.location.href);t.searchParams.delete("redirect"),window.history.replaceState({},"",t.toString()),h.replace(e);return}}if(document.referrer.includes("/auth/")||document.referrer.includes("/login")){{let t=localStorage.getItem("owner_lastBotId");t&&b.bots.some(e=>e.botId===t)&&(e=t)}if(!e){var t;e=null==(t=b.bots[0])?void 0:t.botId}e&&h.replace("/cabinet/".concat(e,"/overview"))}}},[b,N,h]);let S=async(e,t)=>{if(await new Promise(s=>{(0,c.oR)((0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsx)("div",{className:"font-medium",children:"Деактивировать бота?"}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:['Бот "',t,'" будет деактивирован. Это действие можно отменить позже.']}),(0,r.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,r.jsx)("button",{onClick:()=>{c.oR.dismiss(),s(!0)},className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm",children:"Деактивировать"}),(0,r.jsx)("button",{onClick:()=>{c.oR.dismiss(),s(!1)},className:"px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 text-sm",children:"Отмена"})]})]}),{duration:1/0,id:"deactivate-".concat(e)})}))try{await R.mutateAsync(e)}catch(e){console.error("Failed to deactivate bot:",e)}};if(j||O)return(0,r.jsx)("div",{className:"panel p-8",children:"Загрузка..."});let E=null!=(e=null==w?void 0:w.bots.active)?e:0,k=null!=(t=null==w?void 0:w.user.botLimit)?t:3,I=E>=k,P=null!=(s=null==N?void 0:N.items)?s:[];return(0,r.jsxs)("div",{className:"panel p-8",children:[(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h1",{className:"text-2xl font-semibold mb-2",children:"Мои боты"}),(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:["Боты: ",(0,r.jsxs)("span",{className:"font-medium",children:[E,"/",k]})]}),I&&(0,r.jsx)("div",{className:"text-sm text-amber-600 dark:text-amber-400",children:"Лимит достигнут. Удалите бота или обновите план."})]}),(0,r.jsx)("button",{onClick:async()=>{if(!x&&!I){g(!0);try{h.push("/cabinet/create")}catch(s){if((null==s?void 0:s.code)==="BOT_LIMIT_REACHED"||(null==s?void 0:s.error)==="BOT_LIMIT_REACHED"){var e,t;y({activeBots:null!=(e=null==s?void 0:s.activeBots)?e:E,limit:null!=(t=null==s?void 0:s.limit)?t:k}),f(!0)}else console.error("Failed to create bot:",s),alert("Ошибка при создании бота: "+((null==s?void 0:s.message)||"Неизвестная ошибка"))}finally{g(!1)}}},disabled:I||x,className:"px-4 py-2 bg-primary text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary/90",children:x?"Создание...":"Создать бота"})]}),0===P.length?(0,r.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:"У вас пока нет ботов. Создайте первого бота, чтобы начать."}):(0,r.jsx)("div",{className:"space-y-2",children:P.map(e=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium",children:e.name}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:["ID: ",e.botId]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>h.push("/cabinet/".concat(e.botId,"/overview")),className:"px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90",children:"Открыть"}),(0,r.jsx)("button",{onClick:()=>S(e.botId,e.name),disabled:R.isPending,className:"px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50",children:R.isPending?"Деактивация...":"Удалить"})]})]},e.botId))}),p&&v&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 p-6 rounded-lg max-w-md w-full mx-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Лимит ботов достигнут"}),(0,r.jsxs)("p",{className:"text-muted-foreground mb-4",children:["У вас уже ",v.activeBots," активных ботов из ",v.limit," доступных."]}),(0,r.jsx)("button",{onClick:()=>{f(!1),y(null)},className:"w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90",children:"Закрыть"})]})})]})}},78407:(e,t,s)=>{"use strict";s.d(t,{n:()=>n});var r=s(30883),i=s(16144);function n(){return(0,r.I)({queryKey:["owner-me"],queryFn:i.qf,retry:!1})}},86804:(e,t,s)=>{"use strict";var r=s(41764);s.o(r,"useParams")&&s.d(t,{useParams:function(){return r.useParams}}),s.o(r,"usePathname")&&s.d(t,{usePathname:function(){return r.usePathname}}),s.o(r,"useRouter")&&s.d(t,{useRouter:function(){return r.useRouter}}),s.o(r,"useSearchParams")&&s.d(t,{useSearchParams:function(){return r.useSearchParams}})}},e=>{e.O(0,[305,163,883,957,765,337,358],()=>e(e.s=44556)),_N_E=e.O()}]);