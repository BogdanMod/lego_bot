(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[316],{5958:(e,t,s)=>{Promise.resolve().then(s.bind(s,20416))},16144:(e,t,s)=>{"use strict";s.d(t,{CK:()=>b,D6:()=>f,FO:()=>u,HP:()=>y,JD:()=>v,Kj:()=>x,Lu:()=>c,SJ:()=>h,qf:()=>d,w1:()=>p});var r=s(13305);let i="/api/core",a=null,n=r.Ik({user:r.Ik({telegramUserId:r.ai(),username:r.Yj().nullable().optional(),firstName:r.Yj().nullable().optional(),lastName:r.Yj().nullable().optional(),photoUrl:r.Yj().nullable().optional()}),bots:r.YO(r.Ik({botId:r.Yj(),name:r.Yj(),role:r.Yj()})),csrfToken:r.Yj()});async function o(e,t){let s="undefined"!=typeof AbortController?new AbortController:null,r=s?setTimeout(()=>s.abort(),3e3):null;try{let i=await fetch(e,{...t,signal:null==s?void 0:s.signal,credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},cache:"no-store"});r&&clearTimeout(r);let n=await i.json().catch(()=>({}));if(!i.ok){let e=(null==n?void 0:n.message)||"Ошибка запроса",t=(null==n?void 0:n.code)||"request_failed";if("proxy_misconfigured"===t||e.includes("CORE_API_ORIGIN"))e="CORE_API_ORIGIN не настроен. Проверьте переменные окружения в Railway.";else if("misconfigured"===t&&e.includes("Owner auth is not configured")){let t=e.match(/missing ([^,]+(?:, [^,]+)*)/);e=t?"Owner auth не настроен: отсутствуют ".concat(t[1],". Проверьте переменные окружения в сервисе core."):"Owner auth не настроен. Проверьте JWT_SECRET и TELEGRAM_BOT_TOKEN в сервисе core."}if("csrf_failed"===t||"csrf_token_mismatch"===t){a=null;try{a=(await d()).csrfToken||null,e="CSRF токен обновлен. Попробуйте еще раз."}catch(t){e="Ошибка CSRF токена. Обновите страницу."}}else(401===i.status||403===i.status)&&("unauthorized"===t||"invalid_telegram_auth"===t)&&(e=e||"Требуется авторизация. Войдите через Telegram.");throw{code:t,message:e,request_id:null==n?void 0:n.request_id,details:null==n?void 0:n.details}}return n}catch(e){if(r&&clearTimeout(r),(null==e?void 0:e.name)==="AbortError")throw{code:"timeout",message:"Request timeout (3000ms)"};throw e}}function l(e){return e.startsWith("/api/core/")?e:e.startsWith("/api/")?e.replace(/^\/api\//,"/api/core/"):e.startsWith("/")?"".concat(i).concat(e):"".concat(i,"/").concat(e)}function u(e){return o(l("/api/owner/auth/telegram"),{method:"POST",body:JSON.stringify(e)})}function c(e,t){return o(l("/api/owner/auth/botlink"),{method:"POST",body:JSON.stringify({token:e,...t?{next:t}:{}})})}async function d(){let e=await o(l("/api/owner/auth/me")),t=n.parse(e);return a=t.csrfToken,t}function h(){return o(l("/api/owner/auth/logout"),{method:"POST"})}async function m(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(a&&!e)return a;try{return a=(await d()).csrfToken||null}catch(e){return a=null,null}}async function b(e,t){let s=(null==t?void 0:t.method)||"GET",r={};if("GET"!==s){let e=(null==t?void 0:t.csrfToken)||await m();e&&(r["x-csrf-token"]=e)}return o(l(e),{method:s,headers:r,body:(null==t?void 0:t.body)!==void 0?JSON.stringify(t.body):void 0})}async function p(){return o(l("/api/owner/summary"))}async function x(){return o(l("/api/owner/bots"))}async function f(e){return console.log(JSON.stringify({action:"owner_deactivate_bot",botId:e,timestamp:new Date().toISOString()})),await m(),b("/api/owner/bots/".concat(e),{method:"DELETE"})}async function v(){return b("/api/owner/templates")}async function y(e){return b("/api/owner/bots",{method:"POST",body:e})}},20416:(e,t,s)=>{"use strict";s.d(t,{BotsPageClient:()=>d});var r=s(33931),i=s(86804),a=s(51259),n=s(84483),o=s(30883),l=s(37935),u=s(43826),c=s(16144);function d(e){var t,s,d;let{wizardEnabled:m}=e,b=(0,i.useRouter)(),p=(0,n.jE)(),[x,f]=(0,a.useState)(!1),{data:v,isLoading:y}=(0,o.I)({queryKey:["owner-summary"],queryFn:c.w1}),{data:g,isLoading:j}=(0,o.I)({queryKey:["owner-bots"],queryFn:c.Kj}),w=(0,l.n)({mutationFn:c.D6,onSuccess:()=>{p.invalidateQueries({queryKey:["owner-bots"]}),p.invalidateQueries({queryKey:["owner-summary"]}),p.invalidateQueries({queryKey:["owner-me"]}),u.oR.success("Бот успешно деактивирован")},onError:e=>{u.oR.error((null==e?void 0:e.message)||"Ошибка при деактивации бота")}}),N=async(e,t)=>{if(await new Promise(s=>{(0,u.oR)((0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsx)("div",{className:"font-medium",children:"Деактивировать бота?"}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:['Бот "',t,'" будет деактивирован. Это действие можно отменить позже.']}),(0,r.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,r.jsx)("button",{onClick:()=>{u.oR.dismiss(),s(!0)},className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm",children:"Деактивировать"}),(0,r.jsx)("button",{onClick:()=>{u.oR.dismiss(),s(!1)},className:"px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 text-sm",children:"Отмена"})]})]}),{duration:1/0,id:"deactivate-".concat(e)})}))try{await w.mutateAsync(e)}catch(e){console.error("Failed to deactivate bot:",e)}};if(y||j)return(0,r.jsx)("div",{className:"panel p-8",children:(0,r.jsxs)("div",{className:"animate-pulse space-y-4",children:[(0,r.jsx)("div",{className:"h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/4"}),(0,r.jsx)("div",{className:"h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/3"}),(0,r.jsx)("div",{className:"h-10 bg-slate-200 dark:bg-slate-700 rounded w-32"})]})});let k=null!=(t=null==v?void 0:v.bots.active)?t:0,O=null!=(s=null==v?void 0:v.user.botLimit)?s:3,R=k>=O,C=null!=(d=null==g?void 0:g.items)?d:[];return(0,r.jsxs)("div",{className:"panel p-8",children:[(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h1",{className:"text-2xl font-semibold mb-2",children:"Мои боты"}),(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:["Боты: ",(0,r.jsxs)("span",{className:"font-medium",children:[k,"/",O]})]}),R&&(0,r.jsx)("div",{className:"text-sm text-amber-600 dark:text-amber-400",children:"Лимит достигнут. Удалите бота или обновите план."})]}),(0,r.jsx)("button",{onClick:()=>f(!0),disabled:R,className:"px-4 py-2 bg-primary text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary/90",children:"Создать бота"}),!m&&(0,r.jsx)("div",{className:"text-xs text-muted-foreground mt-2",children:"Wizard выключен. Для активации установите ENABLE_OWNER_WIZARD=1"})]}),0===C.length?(0,r.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:"У вас пока нет ботов. Создайте первого бота, чтобы начать."}):(0,r.jsx)("div",{className:"space-y-2",children:C.map(e=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium",children:e.name}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:["ID: ",e.botId]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>b.push("/cabinet/".concat(e.botId,"/overview")),className:"px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90",children:"Открыть"}),(0,r.jsx)("button",{onClick:()=>N(e.botId,e.name),disabled:w.isPending,className:"px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50",children:w.isPending?"Деактивация...":"Удалить"})]})]},e.botId))}),x&&(0,r.jsx)(h,{onClose:()=>f(!1),onSelectTemplate:()=>{f(!1),m?b.push("/cabinet/bots/new?template=true"):b.push("/cabinet/bots/templates")},onCreateFromScratch:()=>{f(!1),b.push("/cabinet/bots/new")},wizardEnabled:m})]})}function h(e){let{onClose:t,onSelectTemplate:s,onCreateFromScratch:i,wizardEnabled:a}=e;return(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:t,children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 p-6 rounded-lg max-w-md w-full mx-4",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Создать бота"}),(0,r.jsxs)("div",{className:"space-y-3",children:[a&&(0,r.jsxs)("button",{onClick:s,className:"w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 text-left",children:[(0,r.jsx)("div",{className:"font-medium",children:"Использовать шаблон"}),(0,r.jsx)("div",{className:"text-sm opacity-90",children:"Выберите из готовых шаблонов"})]}),(0,r.jsxs)("button",{onClick:i,className:"w-full px-4 py-3 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 text-left",children:[(0,r.jsx)("div",{className:"font-medium",children:"Создать с нуля"}),(0,r.jsx)("div",{className:"text-sm opacity-90",children:"Начните с пустого бота"})]})]}),(0,r.jsx)("button",{onClick:t,className:"mt-4 w-full px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600",children:"Отмена"})]})})}},37935:(e,t,s)=>{"use strict";s.d(t,{n:()=>c});var r=s(51259),i=s(14860),a=s(28913),n=s(97194),o=s(92784),l=class extends n.Q{#e;#t=void 0;#s;#r;constructor(e,t){super(),this.#e=e,this.setOptions(t),this.bindMethods(),this.#i()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){let t=this.options;this.options=this.#e.defaultMutationOptions(e),(0,o.f8)(this.options,t)||this.#e.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#s,observer:this}),t?.mutationKey&&this.options.mutationKey&&(0,o.EN)(t.mutationKey)!==(0,o.EN)(this.options.mutationKey)?this.reset():this.#s?.state.status==="pending"&&this.#s.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#s?.removeObserver(this)}onMutationUpdate(e){this.#i(),this.#a(e)}getCurrentResult(){return this.#t}reset(){this.#s?.removeObserver(this),this.#s=void 0,this.#i(),this.#a()}mutate(e,t){return this.#r=t,this.#s?.removeObserver(this),this.#s=this.#e.getMutationCache().build(this.#e,this.options),this.#s.addObserver(this),this.#s.execute(e)}#i(){let e=this.#s?.state??(0,i.$)();this.#t={...e,isPending:"pending"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset}}#a(e){a.jG.batch(()=>{if(this.#r&&this.hasListeners()){let t=this.#t.variables,s=this.#t.context,r={client:this.#e,meta:this.options.meta,mutationKey:this.options.mutationKey};if(e?.type==="success"){try{this.#r.onSuccess?.(e.data,t,s,r)}catch(e){Promise.reject(e)}try{this.#r.onSettled?.(e.data,null,t,s,r)}catch(e){Promise.reject(e)}}else if(e?.type==="error"){try{this.#r.onError?.(e.error,t,s,r)}catch(e){Promise.reject(e)}try{this.#r.onSettled?.(void 0,e.error,t,s,r)}catch(e){Promise.reject(e)}}}this.listeners.forEach(e=>{e(this.#t)})})}},u=s(84483);function c(e,t){let s=(0,u.jE)(t),[i]=r.useState(()=>new l(s,e));r.useEffect(()=>{i.setOptions(e)},[i,e]);let n=r.useSyncExternalStore(r.useCallback(e=>i.subscribe(a.jG.batchCalls(e)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),c=r.useCallback((e,t)=>{i.mutate(e,t).catch(o.lQ)},[i]);if(n.error&&(0,o.GU)(i.options.throwOnError,[n.error]))throw n.error;return{...n,mutate:c,mutateAsync:n.mutate}}},86804:(e,t,s)=>{"use strict";var r=s(41764);s.o(r,"useParams")&&s.d(t,{useParams:function(){return r.useParams}}),s.o(r,"usePathname")&&s.d(t,{usePathname:function(){return r.usePathname}}),s.o(r,"useRouter")&&s.d(t,{useRouter:function(){return r.useRouter}}),s.o(r,"useSearchParams")&&s.d(t,{useSearchParams:function(){return r.useSearchParams}})}},e=>{e.O(0,[305,163,883,957,765,337,358],()=>e(e.s=5958)),_N_E=e.O()}]);