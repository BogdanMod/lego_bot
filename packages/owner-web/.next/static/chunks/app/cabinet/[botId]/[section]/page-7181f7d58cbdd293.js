(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[856],{16144:(e,t,n)=>{"use strict";n.d(t,{CK:()=>p,D6:()=>b,FO:()=>c,HP:()=>j,JD:()=>x,Kj:()=>v,Lu:()=>d,SJ:()=>m,qf:()=>u,w1:()=>f});var r=n(13305);let s="/api/core",a=null,i=r.Ik({user:r.Ik({telegramUserId:r.ai(),username:r.Yj().nullable().optional(),firstName:r.Yj().nullable().optional(),lastName:r.Yj().nullable().optional(),photoUrl:r.Yj().nullable().optional()}),bots:r.YO(r.Ik({botId:r.Yj(),name:r.Yj(),role:r.Yj()})),csrfToken:r.Yj()});async function l(e,t){let n="undefined"!=typeof AbortController?new AbortController:null,r=n?setTimeout(()=>n.abort(),3e3):null;try{let s=await fetch(e,{...t,signal:null==n?void 0:n.signal,credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},cache:"no-store"});r&&clearTimeout(r);let i=await s.json().catch(()=>({}));if(!s.ok){let e=(null==i?void 0:i.message)||"Ошибка запроса",t=(null==i?void 0:i.code)||"request_failed";if("proxy_misconfigured"===t||e.includes("CORE_API_ORIGIN"))e="CORE_API_ORIGIN не настроен. Проверьте переменные окружения в Railway.";else if("misconfigured"===t&&e.includes("Owner auth is not configured")){let t=e.match(/missing ([^,]+(?:, [^,]+)*)/);e=t?"Owner auth не настроен: отсутствуют ".concat(t[1],". Проверьте переменные окружения в сервисе core."):"Owner auth не настроен. Проверьте JWT_SECRET и TELEGRAM_BOT_TOKEN в сервисе core."}if("csrf_failed"===t||"csrf_token_mismatch"===t){a=null;try{a=(await u()).csrfToken||null,e="CSRF токен обновлен. Попробуйте еще раз."}catch(t){e="Ошибка CSRF токена. Обновите страницу."}}else(401===s.status||403===s.status)&&("unauthorized"===t||"invalid_telegram_auth"===t)&&(e=e||"Требуется авторизация. Войдите через Telegram.");throw{code:t,message:e,request_id:null==i?void 0:i.request_id,details:null==i?void 0:i.details}}return i}catch(e){if(r&&clearTimeout(r),(null==e?void 0:e.name)==="AbortError")throw{code:"timeout",message:"Request timeout (3000ms)"};throw e}}function o(e){return e.startsWith("/api/core/")?e:e.startsWith("/api/")?e.replace(/^\/api\//,"/api/core/"):e.startsWith("/")?"".concat(s).concat(e):"".concat(s,"/").concat(e)}function c(e){return l(o("/api/owner/auth/telegram"),{method:"POST",body:JSON.stringify(e)})}function d(e,t){return l(o("/api/owner/auth/botlink"),{method:"POST",body:JSON.stringify({token:e,...t?{next:t}:{}})})}async function u(){let e=await l(o("/api/owner/auth/me")),t=i.parse(e);return a=t.csrfToken,t}function m(){return l(o("/api/owner/auth/logout"),{method:"POST"})}async function h(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(a&&!e)return a;try{return a=(await u()).csrfToken||null}catch(e){return a=null,null}}async function p(e,t){let n=(null==t?void 0:t.method)||"GET",r={};if("GET"!==n){let e=(null==t?void 0:t.csrfToken)||await h();e&&(r["x-csrf-token"]=e)}return l(o(e),{method:n,headers:r,body:(null==t?void 0:t.body)!==void 0?JSON.stringify(t.body):void 0})}async function f(){return l(o("/api/owner/summary"))}async function v(){return l(o("/api/owner/bots"))}async function b(e){return console.log(JSON.stringify({action:"owner_deactivate_bot",botId:e,timestamp:new Date().toISOString()})),await h(),p("/api/owner/bots/".concat(e),{method:"DELETE"})}async function x(){return p("/api/owner/templates")}async function j(e){return p("/api/owner/bots",{method:"POST",body:e})}},39286:(e,t,n)=>{Promise.resolve().then(n.bind(n,65080))},65080:(e,t,n)=>{"use strict";n.d(t,{OwnerSection:()=>h});var r=n(33931),s=n(16144),a=n(30883),i=n(29793),l=n(20232),o=n(80444),c=n(33679),d=n(45166),u=n(3221);function m(e){let{rows:t}=e;if(!t.length)return(0,r.jsxs)("div",{className:"panel p-8 text-center",children:[(0,r.jsx)("div",{className:"text-lg font-medium",children:"Пока пусто"}),(0,r.jsx)("div",{className:"muted text-sm mt-1",children:"Как только появятся события, они будут отображаться здесь."})]});let n=Object.keys(t[0]).slice(0,8);return(0,r.jsx)("div",{className:"panel overflow-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{children:(0,r.jsx)("tr",{className:"border-b border-border",children:n.map(e=>(0,r.jsx)("th",{className:"px-3 py-2 text-left font-medium",children:e},e))})}),(0,r.jsx)("tbody",{children:t.map((e,t)=>(0,r.jsx)("tr",{className:"border-b border-border/60 hover:bg-slate-50 dark:hover:bg-slate-900/40",children:n.map(t=>{var n;return(0,r.jsx)("td",{className:"px-3 py-2 align-top",children:"object"==typeof e[t]?JSON.stringify(e[t]):String(null!=(n=e[t])?n:"")},t)})},t))})]})})}function h(e){let{botId:t,section:n}=e,h="overview"===n?"/api/owner/bots/".concat(t,"/events/summary"):"inbox"===n?"/api/owner/bots/".concat(t,"/events?limit=100"):"calendar"===n?"/api/owner/bots/".concat(t,"/appointments"):"orders"===n?"/api/owner/bots/".concat(t,"/orders?limit=100"):"leads"===n?"/api/owner/bots/".concat(t,"/leads?limit=100"):"customers"===n?"/api/owner/bots/".concat(t,"/customers?limit=100"):"team"===n?"/api/owner/bots/".concat(t,"/team"):"settings"===n?"/api/owner/bots/".concat(t):"/api/owner/bots/".concat(t,"/audit?limit=100"),{data:p,isLoading:f,error:v}=(0,a.I)({queryKey:["owner-section",t,n],queryFn:()=>(0,s.CK)(h)});if(f)return(0,r.jsx)("div",{className:"panel p-8",children:"Загрузка данных..."});if(v)return(0,r.jsxs)("div",{className:"panel p-8",children:[(0,r.jsx)("div",{className:"text-red-500 font-medium",children:"Ошибка загрузки"}),(0,r.jsx)("div",{className:"text-sm muted mt-1",children:(null==v?void 0:v.message)||"Неизвестная ошибка"}),(0,r.jsxs)("div",{className:"text-xs muted mt-1",children:["request_id: ",(null==v?void 0:v.request_id)||"n/a"]})]});if("overview"===n){let e=Object.entries((null==p?void 0:p.byType)||{}).map(e=>{let[t,n]=e;return{name:t,value:n}});return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,r.jsxs)("div",{className:"panel p-4",children:[(0,r.jsx)("div",{className:"text-sm muted",children:"Всего событий"}),(0,r.jsx)("div",{className:"text-3xl font-semibold mt-1",children:(null==p?void 0:p.total)||0})]}),Object.entries((null==p?void 0:p.byStatus)||{}).map(e=>{let[t,n]=e;return(0,r.jsxs)("div",{className:"panel p-4",children:[(0,r.jsxs)("div",{className:"text-sm muted",children:["Статус: ",t]}),(0,r.jsx)("div",{className:"text-3xl font-semibold mt-1",children:n})]},t)})]}),(0,r.jsxs)("div",{className:"panel p-4",children:[(0,r.jsx)("div",{className:"font-medium mb-3",children:"События по типам"}),(0,r.jsx)("div",{className:"h-[280px]",children:(0,r.jsx)(i.u,{width:"100%",height:"100%",children:(0,r.jsxs)(l.E,{data:e,children:[(0,r.jsx)(o.W,{dataKey:"name"}),(0,r.jsx)(c.h,{}),(0,r.jsx)(d.m,{}),(0,r.jsx)(u.y,{dataKey:"value",fill:"hsl(var(--primary))",radius:6})]})})})]})]})}let b=Array.isArray(null==p?void 0:p.items)?p.items:Array.isArray(p)?p:p?[p]:[];return(0,r.jsx)(m,{rows:b})}}},e=>{e.O(0,[305,163,883,290,765,337,358],()=>e(e.s=39286)),_N_E=e.O()}]);