(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[658],{6615:(e,t,r)=>{"use strict";r.d(t,{CabinetLayout:()=>v});var n=r(33931),a=r(16144),o=r(78407),s=r(51259),l=r(84483),c=r(86804),i=r(57023),d=r(65940);function u(e){let{bots:t,currentBotId:r}=e,a=(0,c.useRouter)(),o=(0,c.usePathname)(),[l,u]=(0,s.useState)(!1),[m,b]=(0,s.useState)(""),v=(0,s.useRef)(null),x=t.find(e=>e.botId===r),f=m?t.filter(e=>e.name.toLowerCase().includes(m.toLowerCase())):t;(0,s.useEffect)(()=>{let e=e=>{v.current&&!v.current.contains(e.target)&&(u(!1),b(""))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);let h=x?d.R.roles[x.role]||x.role:"";return(0,n.jsxs)("div",{className:"relative",ref:v,children:[(0,n.jsxs)("button",{onClick:()=>u(!l),className:"flex items-center gap-2 px-3 py-2 rounded-lg border border-border bg-card hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[(0,n.jsxs)("div",{className:"text-left",children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:(null==x?void 0:x.name)||d.R.bot.selectBot}),x&&(0,n.jsxs)("div",{className:"text-xs text-muted-foreground",children:[d.R.bot.context,": ",x.name]})]}),x&&h&&(0,n.jsx)(i.E,{variant:"owner"===x.role?"success":"default",children:h}),(0,n.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat(l?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),l&&(0,n.jsxs)("div",{className:"absolute top-full left-0 mt-1 w-64 bg-card border border-border rounded-lg shadow-lg z-50 max-h-96 overflow-hidden flex flex-col",children:[(0,n.jsx)("div",{className:"p-2 border-b border-border",children:(0,n.jsx)("input",{type:"text",placeholder:d.R.common.search,value:m,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 text-sm rounded border border-border bg-background focus:outline-none focus:ring-2 focus:ring-primary",autoFocus:!0})}),(0,n.jsx)("div",{className:"overflow-y-auto",children:0===f.length?(0,n.jsx)("div",{className:"p-4 text-sm text-muted-foreground text-center",children:d.R.bot.noBots}):f.map(e=>(0,n.jsx)("button",{onClick:()=>(e=>{u(!1),b("");let t=o.match(/\/cabinet\/[^/]+\/(.+)/),r=t?t[1]:"overview";a.push("/cabinet/".concat(e,"/").concat(r)),localStorage.setItem("owner_lastBotId",e)})(e.botId),className:"w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors ".concat(e.botId===r?"bg-primary/10":""),children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:e.name}),(0,n.jsxs)("div",{className:"text-xs text-muted-foreground",children:["ID: ",e.botId.slice(0,8),"..."]})]}),(0,n.jsx)(i.E,{variant:"owner"===e.role?"success":"default",children:d.R.roles[e.role]||e.role})]})},e.botId))})]})]})}function m(e){let{botId:t}=e,{isOpen:r,setIsOpen:a,search:o,setSearch:l,commands:i}=function(e){let t=(0,c.useRouter)();(0,c.usePathname)();let[r,n]=(0,s.useState)(!1),[a,o]=(0,s.useState)("");(0,s.useEffect)(()=>{let e=e=>{(e.metaKey||e.ctrlKey)&&"k"===e.key&&(e.preventDefault(),n(e=>!e)),"Escape"===e.key&&r&&(n(!1),o(""))};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[r]);let l=e?[{id:"inbox",label:d.R.nav.inbox,shortcut:"g i",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/inbox")),n(!1)}},{id:"calendar",label:d.R.nav.calendar,shortcut:"g k",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/calendar")),n(!1)}},{id:"orders",label:d.R.nav.orders,shortcut:"g o",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/orders")),n(!1)}},{id:"leads",label:d.R.nav.leads,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/leads")),n(!1)}},{id:"customers",label:d.R.nav.customers,shortcut:"g c",category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/customers")),n(!1)}},{id:"overview",label:d.R.nav.overview,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/overview")),n(!1)}},{id:"team",label:d.R.nav.team,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/team")),n(!1)}},{id:"settings",label:d.R.nav.settings,category:"Навигация",action:()=>{t.push("/cabinet/".concat(e,"/settings")),n(!1)}}]:[],i=a?l.filter(e=>e.label.toLowerCase().includes(a.toLowerCase())):l;return{isOpen:r,setIsOpen:n,search:a,setSearch:o,commands:i}}(t),u=(0,s.useRef)(null);return((0,s.useEffect)(()=>{r&&u.current&&u.current.focus()},[r]),r)?(0,n.jsxs)("div",{className:"fixed inset-0 z-50 flex items-start justify-center pt-[20vh]",children:[(0,n.jsx)("div",{className:"fixed inset-0 bg-black/50",onClick:()=>a(!1)}),(0,n.jsxs)("div",{className:"relative w-full max-w-2xl bg-card border border-border rounded-lg shadow-xl",children:[(0,n.jsx)("div",{className:"p-4 border-b border-border",children:(0,n.jsx)("input",{ref:u,type:"text",placeholder:"Поиск команд...",value:o,onChange:e=>l(e.target.value),className:"w-full bg-transparent outline-none text-lg"})}),(0,n.jsx)("div",{className:"max-h-96 overflow-y-auto",children:0===i.length?(0,n.jsx)("div",{className:"p-4 text-sm text-muted-foreground text-center",children:"Нет результатов"}):i.map(e=>(0,n.jsxs)("button",{onClick:e.action,className:"w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-medium",children:e.label}),(0,n.jsx)("div",{className:"text-xs text-muted-foreground",children:e.category})]}),e.shortcut&&(0,n.jsx)("kbd",{className:"px-2 py-1 text-xs bg-slate-100 dark:bg-slate-800 rounded",children:e.shortcut})]},e.id))})]})]}):null}let b=[{key:"overview",label:d.R.nav.overview},{key:"inbox",label:d.R.nav.inbox},{key:"calendar",label:d.R.nav.calendar},{key:"orders",label:d.R.nav.orders},{key:"leads",label:d.R.nav.leads},{key:"customers",label:d.R.nav.customers},{key:"team",label:d.R.nav.team},{key:"settings",label:d.R.nav.settings},{key:"audit",label:d.R.nav.audit}];function v(e){var t,r;let{children:i}=e,v=(0,c.useRouter)(),x=(0,c.usePathname)(),f=(0,c.useParams)(),{data:h,isLoading:p,isError:g}=(0,o.n)(),y=null==f?void 0:f.botId;(null==h||null==(t=h.bots)?void 0:t.find(e=>e.botId===y))||null==h||null==(r=h.bots)||r[0];let w=(0,c.useRouter)();(0,s.useEffect)(()=>{let e=e=>{var t;if("/"===e.key&&(null==(t=e.target)?void 0:t.tagName)!=="INPUT"){e.preventDefault();let t=document.getElementById("global-search");null==t||t.focus()}if("g"===e.key.toLowerCase()&&y){let e=t=>{"i"===t.key.toLowerCase()&&w.push("/cabinet/".concat(y,"/inbox")),"c"===t.key.toLowerCase()&&w.push("/cabinet/".concat(y,"/calendar")),document.removeEventListener("keydown",e)};document.addEventListener("keydown",e)}};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[y,w]);let k=(0,l.jE)(),j=(0,s.useRef)(null);return((0,s.useEffect)(()=>{if(!y)return;let e=new EventSource("/api/core/owner/bots/".concat(y,"/stream"));return j.current=e,e.onopen=()=>{console.log("[SSE] Connected",{botId:y})},e.addEventListener("connected",e=>{console.log("[SSE] Connection confirmed",JSON.parse(e.data))}),e.addEventListener("event",e=>{console.log("[SSE] Event received",JSON.parse(e.data)),k.invalidateQueries({queryKey:["owner-section",y]}),k.invalidateQueries({queryKey:["owner-events",y]}),k.invalidateQueries({queryKey:["owner-customers",y]}),k.invalidateQueries({queryKey:["owner-orders",y]}),k.invalidateQueries({queryKey:["owner-leads",y]})}),e.addEventListener("ping",()=>{}),e.addEventListener("error",e=>{console.error("[SSE] Error",e)}),e.onerror=e=>{console.error("[SSE] Connection error",e)},()=>{e.close(),j.current=null}},[y,k]),(0,s.useEffect)(()=>{p||!g&&h||v.replace("/login")},[g,p,h,v]),p||!h)?(0,n.jsx)("div",{className:"min-h-screen p-8",children:d.R.common.loading}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(m,{botId:y}),(0,n.jsxs)("div",{className:"min-h-screen grid grid-cols-[260px_1fr]",children:[(0,n.jsxs)("aside",{className:"border-r border-border bg-card p-5",children:[(0,n.jsx)("div",{className:"text-xl font-semibold",children:"Owner Cabinet"}),(0,n.jsx)("div",{className:"mt-1 text-sm text-muted-foreground",children:h.user.firstName||"Пользователь"}),(0,n.jsx)("div",{className:"mt-6 text-xs uppercase tracking-wide text-muted-foreground",children:"Разделы"}),(0,n.jsx)("nav",{className:"mt-2 space-y-1",children:b.map(e=>{let t=y?"/cabinet/".concat(y,"/").concat(e.key):"/cabinet",r=x.startsWith(t);return(0,n.jsx)("button",{onClick:()=>v.push(t),className:"w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ".concat(r?"bg-primary text-white":"hover:bg-slate-100 dark:hover:bg-slate-800 text-foreground"),children:e.label},e.key)})}),(0,n.jsx)("button",{className:"mt-8 w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",onClick:async()=>{await (0,a.SJ)(),v.replace("/login")},children:"Выйти"})]}),(0,n.jsxs)("div",{className:"p-6",children:[(0,n.jsxs)("header",{className:"panel px-4 py-3 flex items-center gap-3 justify-between mb-4",children:[(0,n.jsx)(u,{bots:h.bots||[],currentBotId:y}),(0,n.jsx)("input",{id:"global-search",placeholder:"".concat(d.R.common.search," (/)"),className:"w-[360px] rounded-lg border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-primary",onChange:async e=>{if(!y)return;let t=e.target.value.trim();t&&await (0,a.CK)("/api/owner/bots/".concat(y,"/events?q=").concat(encodeURIComponent(t),"&limit=20"))}})]}),(0,n.jsx)("div",{children:i})]})]})]})}},16144:(e,t,r)=>{"use strict";r.d(t,{CK:()=>v,D6:()=>h,FO:()=>i,Kj:()=>f,Lu:()=>d,SJ:()=>m,qf:()=>u,w1:()=>x});var n=r(13305);let a="/api/core",o=null,s=n.Ik({user:n.Ik({telegramUserId:n.ai(),username:n.Yj().nullable().optional(),firstName:n.Yj().nullable().optional(),lastName:n.Yj().nullable().optional(),photoUrl:n.Yj().nullable().optional()}),bots:n.YO(n.Ik({botId:n.Yj(),name:n.Yj(),role:n.Yj()})),csrfToken:n.Yj()});async function l(e,t){let r=await fetch(e,{...t,credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},cache:"no-store"}),n=await r.json().catch(()=>({}));if(!r.ok)throw{code:(null==n?void 0:n.code)||"request_failed",message:(null==n?void 0:n.message)||"Ошибка запроса",request_id:null==n?void 0:n.request_id,details:null==n?void 0:n.details};return n}function c(e){return e.startsWith("/api/core/")?e:e.startsWith("/api/")?e.replace(/^\/api\//,"/api/core/"):e.startsWith("/")?"".concat(a).concat(e):"".concat(a,"/").concat(e)}function i(e){return l(c("/api/owner/auth/telegram"),{method:"POST",body:JSON.stringify(e)})}function d(e){return l(c("/api/owner/auth/botlink"),{method:"POST",body:JSON.stringify({token:e})})}async function u(){let e=await l(c("/api/owner/auth/me")),t=s.parse(e);return o=t.csrfToken,t}function m(){return l(c("/api/owner/auth/logout"),{method:"POST"})}async function b(){if(o)return o;try{return(await u()).csrfToken||null}catch(e){return null}}async function v(e,t){let r=(null==t?void 0:t.method)||"GET",n={};if("GET"!==r){let e=(null==t?void 0:t.csrfToken)||await b();e&&(n["x-csrf-token"]=e)}return l(c(e),{method:r,headers:n,body:(null==t?void 0:t.body)!==void 0?JSON.stringify(t.body):void 0})}async function x(){return l(c("/api/owner/summary"))}async function f(){return l(c("/api/owner/bots"))}async function h(e){return l(c("/api/owner/bots/".concat(e)),{method:"DELETE"})}},25632:(e,t,r)=>{Promise.resolve().then(r.bind(r,6615))},36669:(e,t,r)=>{"use strict";r.d(t,{cn:()=>o});var n=r(73682),a=r(72454);function o(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,a.QP)((0,n.$)(t))}},57023:(e,t,r)=>{"use strict";r.d(t,{E:()=>o});var n=r(33931),a=r(36669);function o(e){let{variant:t="default",children:r,className:o}=e;return(0,n.jsx)("span",{className:(0,a.cn)("inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium",{"bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-200":"default"===t,"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":"success"===t,"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"warning"===t,"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200":"danger"===t,"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200":"info"===t},o),children:r})}},65940:(e,t,r)=>{"use strict";r.d(t,{R:()=>n});let n={common:{loading:"Загрузка...",error:"Ошибка",save:"Сохранить",cancel:"Отмена",delete:"Удалить",edit:"Редактировать",create:"Создать",search:"Поиск",filter:"Фильтр",clear:"Очистить",apply:"Применить",close:"Закрыть",back:"Назад",next:"Далее",previous:"Назад",refresh:"Обновить",export:"Экспорт",import:"Импорт"},nav:{overview:"Обзор",inbox:"Входящие",calendar:"Календарь",orders:"Заказы",leads:"Лиды",customers:"Клиенты",team:"Команда",settings:"Настройки",audit:"Аудит"},roles:{owner:"Владелец",admin:"Администратор",staff:"Сотрудник",viewer:"Наблюдатель"},bot:{selectBot:"Выберите бота",switchBot:"Переключить бота",noBots:"Нет доступных ботов",context:"Контекст",role:"Роль"},inbox:{title:"Входящие",new:"Новые",inProgress:"В работе",done:"Выполнено",cancelled:"Отменено",unassigned:"Не назначено",assignToMe:"Назначить мне",markAsDone:"Отметить выполненным",createOrder:"Создать заказ",createLead:"Создать лид",createAppointment:"Создать запись",empty:"Нет событий",emptyDesc:"Все события будут отображаться здесь"},orders:{title:"Заказы",new:"Новые",processing:"В обработке",completed:"Завершено",cancelled:"Отменено",empty:"Нет заказов",emptyDesc:"Заказы будут отображаться здесь"},leads:{title:"Лиды",new:"Новые",contacted:"Связались",qualified:"Квалифицированы",converted:"Конвертированы",lost:"Потеряны",empty:"Нет лидов",emptyDesc:"Лиды будут отображаться здесь"},customers:{title:"Клиенты",empty:"Нет клиентов",emptyDesc:"Клиенты будут отображаться здесь"},calendar:{title:"Календарь",empty:"Нет записей",emptyDesc:"Записи будут отображаться здесь"},team:{title:"Команда",addMember:"Добавить участника",empty:"Нет участников",emptyDesc:"Добавьте участников команды"},settings:{title:"Настройки",general:"Общие",notifications:"Уведомления",integrations:"Интеграции"},audit:{title:"Аудит",empty:"Нет записей",emptyDesc:"История изменений будет отображаться здесь"},errors:{notFound:"Не найдено",unauthorized:"Требуется авторизация",forbidden:"Доступ запрещен",serverError:"Ошибка сервера",networkError:"Ошибка сети",unknown:"Неизвестная ошибка",requestId:"ID запроса",details:"Подробнее"},dashboard:{title:"Обзор",kpi:{newLeads:"Новые лиды",orders:"Заказы",revenue:"Выручка",conversion:"Конверсия"},trends:"Тренды",recent:"Недавние"}}},78407:(e,t,r)=>{"use strict";r.d(t,{n:()=>o});var n=r(30883),a=r(16144);function o(){return(0,n.I)({queryKey:["owner-me"],queryFn:a.qf,retry:!1})}}},e=>{e.O(0,[305,251,883,844,765,337,358],()=>e(e.s=25632)),_N_E=e.O()}]);