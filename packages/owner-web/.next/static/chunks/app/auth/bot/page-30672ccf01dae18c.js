(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[651],{16144:(e,t,n)=>{"use strict";n.d(t,{CK:()=>h,D6:()=>w,FO:()=>u,HP:()=>g,JD:()=>y,Kj:()=>b,Lu:()=>c,SJ:()=>m,qf:()=>d,w1:()=>p});var r=n(13305);let a="/api/core",s=null,i=r.Ik({user:r.Ik({telegramUserId:r.ai(),username:r.Yj().nullable().optional(),firstName:r.Yj().nullable().optional(),lastName:r.Yj().nullable().optional(),photoUrl:r.Yj().nullable().optional()}),bots:r.YO(r.Ik({botId:r.Yj(),name:r.Yj(),role:r.Yj()})),csrfToken:r.Yj()});async function o(e,t){let n="undefined"!=typeof AbortController?new AbortController:null,r=n?setTimeout(()=>n.abort(),3e3):null;try{let a=await fetch(e,{...t,signal:null==n?void 0:n.signal,credentials:"include",headers:{"Content-Type":"application/json",...(null==t?void 0:t.headers)||{}},cache:"no-store"});r&&clearTimeout(r);let i=await a.json().catch(()=>({}));if(!a.ok){let e=(null==i?void 0:i.message)||"Ошибка запроса",t=(null==i?void 0:i.code)||"request_failed";if("proxy_misconfigured"===t||e.includes("CORE_API_ORIGIN"))e="CORE_API_ORIGIN не настроен. Проверьте переменные окружения в Railway.";else if("misconfigured"===t&&e.includes("Owner auth is not configured")){let t=e.match(/missing ([^,]+(?:, [^,]+)*)/);e=t?"Owner auth не настроен: отсутствуют ".concat(t[1],". Проверьте переменные окружения в сервисе core."):"Owner auth не настроен. Проверьте JWT_SECRET и TELEGRAM_BOT_TOKEN в сервисе core."}if("csrf_failed"===t||"csrf_token_mismatch"===t){s=null;try{s=(await d()).csrfToken||null,e="CSRF токен обновлен. Попробуйте еще раз."}catch(t){e="Ошибка CSRF токена. Обновите страницу."}}else(401===a.status||403===a.status)&&("unauthorized"===t||"invalid_telegram_auth"===t)&&(e=e||"Требуется авторизация. Войдите через Telegram.");throw{code:t,message:e,request_id:null==i?void 0:i.request_id,details:null==i?void 0:i.details}}return i}catch(e){if(r&&clearTimeout(r),(null==e?void 0:e.name)==="AbortError")throw{code:"timeout",message:"Request timeout (3000ms)"};throw e}}function l(e){return e.startsWith("/api/core/")?e:e.startsWith("/api/")?e.replace(/^\/api\//,"/api/core/"):e.startsWith("/")?"".concat(a).concat(e):"".concat(a,"/").concat(e)}function u(e){return o(l("/api/owner/auth/telegram"),{method:"POST",body:JSON.stringify(e)})}function c(e,t){return o(l("/api/owner/auth/botlink"),{method:"POST",body:JSON.stringify({token:e,...t?{next:t}:{}})})}async function d(){let e=await o(l("/api/owner/auth/me")),t=i.parse(e);return s=t.csrfToken,t}function m(){return o(l("/api/owner/auth/logout"),{method:"POST"})}async function f(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(s&&!e)return s;try{return s=(await d()).csrfToken||null}catch(e){return s=null,null}}async function h(e,t){let n=(null==t?void 0:t.method)||"GET",r={};if("GET"!==n){let e=(null==t?void 0:t.csrfToken)||await f();e&&(r["x-csrf-token"]=e)}return o(l(e),{method:n,headers:r,body:(null==t?void 0:t.body)!==void 0?JSON.stringify(t.body):void 0})}async function p(){return o(l("/api/owner/summary"))}async function b(){return o(l("/api/owner/bots"))}async function w(e){return console.log(JSON.stringify({action:"owner_deactivate_bot",botId:e,timestamp:new Date().toISOString()})),await f(),h("/api/owner/bots/".concat(e),{method:"DELETE"})}async function y(){return h("/api/owner/templates")}async function g(e){return h("/api/owner/bots",{method:"POST",body:e})}},62942:(e,t,n)=>{Promise.resolve().then(n.bind(n,89288))},86804:(e,t,n)=>{"use strict";var r=n(41764);n.o(r,"useParams")&&n.d(t,{useParams:function(){return r.useParams}}),n.o(r,"usePathname")&&n.d(t,{usePathname:function(){return r.usePathname}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})},89288:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>u,dynamic:()=>o});var r=n(33931),a=n(16144),s=n(86804),i=n(51259);let o="force-dynamic";function l(){let e=(0,s.useSearchParams)(),t=(0,s.useRouter)(),[n,o]=(0,i.useState)(null),[l,u]=(0,i.useState)(!0);return(0,i.useEffect)(()=>{let n=e.get("token");if(!n){o("Ссылка входа некорректна. Вернитесь в Telegram и отправьте /cabinet."),u(!1);return}let r=e.get("next"),s=r&&r.startsWith("/")&&!r.includes("://")&&!r.startsWith("//")?r:"/cabinet",i=!1;return(async()=>{try{let e=await (0,a.Lu)(n,s);if(i)return;let r=e.redirect||s;t.replace(r)}catch(e){if(i)return;o((null==e?void 0:e.code)?"botlink_used"===e.code?"Эта ссылка уже использована. Откройте Telegram и снова отправьте /cabinet.":"botlink_expired"===e.code?"Срок действия ссылки истек. Откройте Telegram и снова отправьте /cabinet.":"no_bots_access"===e.code?"У вас нет доступа к кабинетам. Обратитесь к владельцу бота для выдачи прав.":e.message||"Не удалось выполнить вход. Попробуйте снова через /cabinet.":"Не удалось выполнить вход. Попробуйте снова через /cabinet."),u(!1)}})(),()=>{i=!0}},[t,e]),(0,r.jsxs)(r.Fragment,{children:[l?(0,r.jsx)("p",{className:"muted mt-3",children:"Проверяем ссылку входа..."}):null,n?(0,r.jsx)("div",{className:"mt-4 text-sm text-red-500",children:n}):null,l?null:(0,r.jsxs)("p",{className:"muted mt-4 text-sm",children:["Вернитесь в Telegram, отправьте команду ",(0,r.jsx)("b",{children:"/cabinet"})," и откройте новую ссылку."]})]})}function u(){return(0,r.jsx)("main",{className:"min-h-screen flex items-center justify-center p-6",children:(0,r.jsxs)("div",{className:"panel w-full max-w-xl p-8",children:[(0,r.jsx)("h1",{className:"text-2xl font-semibold",children:"Вход в Owner Cabinet"}),(0,r.jsx)(i.Suspense,{fallback:(0,r.jsx)("p",{className:"muted mt-3",children:"Загрузка..."}),children:(0,r.jsx)(l,{})})]})})}}},e=>{e.O(0,[305,765,337,358],()=>e(e.s=62942)),_N_E=e.O()}]);