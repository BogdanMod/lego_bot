# Заявки и «Поделиться номером» (request_contact)

## Что считается заявкой (lead)

В аналитике **заявкой** считается одно из двух:

1. **Пользователь нажал «Поделиться номером»** и отправил контакт (Telegram `request_contact`).  
   Router при получении `update.message.contact` вызывает ingest с `requestContact: true` → в БД создаётся запись в таблице `leads` (с учётом дедупа за 10 минут).

2. **Пользователь дошёл до финального шага заявки** по схеме бота: переход в state с `track: { event: 'lead' }` (или нажатие кнопки с таким `track`).  
   Router при callback определяет `trackEvent` из схемы и создаёт lead при `track.event === 'lead'`.

В обоих случаях действует **дедупликация**: для одной пары (bot_id, customer_id) не создаётся вторая запись в `leads` в течение 10 минут.

## Как устроен шаг «Поделиться номером»

- В BotSchema поддерживается кнопка с **`type: 'request_contact'`**:
  - `text` — подпись кнопки (например «Поделиться номером»),
  - `nextState` — экран, на который перейти после отправки контакта.
  - Опционально **`track: { event: 'lead' }`** для явной аналитики (по умолчанию контакт и так даёт lead).

- В Telegram такая кнопка отображается как **Reply Keyboard** (кнопка под полем ввода с запросом номера телефона), а не как inline-кнопка. Router всегда рендерит `request_contact` через Reply Keyboard.

- После отправки контакта пользователь переходит в `nextState` (например экран «Спасибо, мы получили ваш номер…»). Номер сохраняется в профиле пользователя бота.

## Шаблоны и новые боты

- **Шаблоны (owner-web):** у шаблонов с записью/заявкой при включённых модулях `schedule` или `leads` в схему добавляются состояния **`lead_contact`** и **`lead_thanks`**:
  - `lead_contact`: сообщение «Нажмите кнопку ниже, чтобы поделиться номером» и кнопка `request_contact` с `nextState: 'lead_thanks'` и `track: { event: 'lead' }`.
  - `lead_thanks`: сообщение «Спасибо, мы получили ваш номер…» и кнопка «В главное меню».

- **AI-схема (создать с нуля):** в промпте генерации задано обязательно включать сценарий заявки с `request_contact` и финальным state `lead_thanks` с `track: { event: 'lead' }`.

- **Конструктор (owner-web):** в редакторе кнопок можно выбрать тип **«Контакт (телефон)»**; для такой кнопки задаётся переход (`nextState`) и при необходимости событие для аналитики: **Заявка** (lead) или **Запись** (appointment).

## Обратная совместимость

- Существующие боты и схемы **не меняются** автоматически. Если в схеме нет `request_contact` и нет `track`, поведение остаётся прежним (при включённом fallback может срабатывать эвристика по тексту).
- Никаких автопатчей БД и новых обязательных переменных окружения нет.

## Пример схемы (request_contact + track)

Фрагмент схемы шаблона с шагом «Поделиться номером» (для PR / тестов):

```json
{
  "version": 1,
  "initial": "menu",
  "states": {
    "menu": {
      "message": "Главное меню",
      "buttons": [
        { "text": "Записаться", "nextState": "lead_contact" }
      ]
    },
    "lead_contact": {
      "message": "Нажмите кнопку ниже, чтобы поделиться номером.",
      "buttons": [
        {
          "type": "request_contact",
          "text": "Поделиться номером",
          "nextState": "lead_thanks",
          "track": { "event": "lead" }
        }
      ]
    },
    "lead_thanks": {
      "message": "Спасибо, мы получили ваш номер. Мы свяжемся с вами.",
      "buttons": [
        { "text": "В главное меню", "nextState": "menu" }
      ]
    }
  }
}
```

## Проверки (ручные сценарии)

1. Создать бота из шаблона (например «Салон красоты») → в боте дойти до «Поделиться номером» → нажать кнопку и отправить контакт → в БД одна запись в `leads`, в аналитике увеличивается счётчик заявок.
2. Дважды нажать «Поделиться номером» в течение 10 минут → в `leads` остаётся одна запись (дедуп).
3. Старый бот без `track` и без `request_contact` продолжает работать по-старому.
